<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>10 广播 - 迭代自己</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="iterateself" />
  <meta name="description" content="A.3 Broadcasting（广播） 广播（Broadcasting）指的是有不同形状的数组是如何进行运算的。尽管很强大，但却很容易被混淆。一个" />

  <meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.47.1" />


<link rel="canonical" href="http://iterate.site/post/01-%E7%9F%A5%E8%AF%86%E6%A0%91/03-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/01-%E5%9F%BA%E7%A1%80%E7%BC%96%E7%A8%8B/01-%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/02-python/02data/02-numpy/10-%E5%B9%BF%E6%92%AD/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">




<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<link href="/dist/even.min.css?v=3.2.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="10 广播" />
<meta property="og:description" content="A.3 Broadcasting（广播） 广播（Broadcasting）指的是有不同形状的数组是如何进行运算的。尽管很强大，但却很容易被混淆。一个" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://iterate.site/post/01-%E7%9F%A5%E8%AF%86%E6%A0%91/03-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/01-%E5%9F%BA%E7%A1%80%E7%BC%96%E7%A8%8B/01-%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/02-python/02data/02-numpy/10-%E5%B9%BF%E6%92%AD/" /><meta property="article:published_time" content="2018-08-03T11:23:27&#43;00:00"/>
<meta property="article:modified_time" content="2018-08-03T11:23:27&#43;00:00"/>
<meta itemprop="name" content="10 广播">
<meta itemprop="description" content="A.3 Broadcasting（广播） 广播（Broadcasting）指的是有不同形状的数组是如何进行运算的。尽管很强大，但却很容易被混淆。一个">


<meta itemprop="datePublished" content="2018-08-03T11:23:27&#43;00:00" />
<meta itemprop="dateModified" content="2018-08-03T11:23:27&#43;00:00" />
<meta itemprop="wordCount" content="1470">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="10 广播"/>
<meta name="twitter:description" content="A.3 Broadcasting（广播） 广播（Broadcasting）指的是有不同形状的数组是如何进行运算的。尽管很强大，但却很容易被混淆。一个"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">iterate self</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">about</li>
      </a><a href="/catalog/">
        <li class="mobile-menu-item">目录</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">iterate self</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">about</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/catalog/">目录</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">10 广播</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-08-03 </span>
        
        <span class="more-meta"> 1470 words </span>
        <span class="more-meta"> 3 mins read </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#a-3-broadcasting-广播">A.3 Broadcasting（广播）</a></li>
<li><a href="#1-broadcasting-over-other-axes-在其他轴上进行广播">1 Broadcasting Over Other Axes（在其他轴上进行广播）</a></li>
<li><a href="#2-setting-array-values-by-broadcasting-通过广播设置数组值">2 Setting Array Values by Broadcasting（通过广播设置数组值）</a></li>
</ul>
</nav>
  </div>
</div>

    
    

    
    <div class="post-content">
      

<h1 id="a-3-broadcasting-广播">A.3 Broadcasting（广播）</h1>

<p>广播（Broadcasting）指的是有不同形状的数组是如何进行运算的。尽管很强大，但却很容易被混淆。一个最简单的例子是把一个标量作用在一个数组上的时候：</p>

<pre><code class="language-python">import numpy as np
</code></pre>

<pre><code class="language-python">arr = np.arange(5)
arr
</code></pre>

<pre><code>array([0, 1, 2, 3, 4])
</code></pre>

<pre><code class="language-python">arr * 4
</code></pre>

<pre><code>array([ 0,  4,  8, 12, 16])
</code></pre>

<p>这里我们说标量4被广播给了其他元素。</p>

<p>例如，我们想要把每一列的数组都减去这一列的平均数（这种做法为demean，译为减去平均数）：</p>

<pre><code class="language-python">arr = np.random.randn(4, 3)
arr
</code></pre>

<pre><code>array([[ 0.19112706, -0.07585204,  1.33214545],
       [-1.51473946,  1.29163832,  0.22056989],
       [ 0.5696424 , -1.11391716,  0.13913336],
       [ 1.2059608 , -0.71633243, -0.2735593 ]])
</code></pre>

<pre><code class="language-python">arr.mean(0)
</code></pre>

<pre><code>array([ 0.1129977 , -0.15361583,  0.35457235])
</code></pre>

<pre><code class="language-python">demeaned = arr - arr.mean(0)
demeaned
</code></pre>

<pre><code>array([[ 0.07812936,  0.07776379,  0.9775731 ],
       [-1.62773716,  1.44525415, -0.13400246],
       [ 0.4566447 , -0.96030133, -0.21543899],
       [ 1.0929631 , -0.5627166 , -0.62813165]])
</code></pre>

<pre><code class="language-python">demeaned.mean(0) # 下面的结果可以理解为等于0
</code></pre>

<pre><code>array([  5.55111512e-17,   5.55111512e-17,   2.77555756e-17])
</code></pre>

<p>下图演示了上面的操作原理。对行进行减去平均数是一种广播操作，这种操作需要小心一点。不过只要遵守规则，广播可以把低维的值广播到一个数组上的任何维度（比如在一个二维数组中，让每一行减去那一行的平均值）。</p>

<p><img src="http://pacdb2bfr.bkt.clouddn.com/blog/image/180803/300l8D40e2.png?imageslim" alt="mark" /></p>

<p><strong>The Broadcasting Rule</strong>（广播规则）</p>

<p>Two arrays are compatible for broadcasting if for each trailing dimension (i.e., starting from the end) the axis lengths match or if either of the lengths is 1. Broadcasting is then performed over the missing or length 1 dimensions.</p>

<p>要想让两个数组进行广播，在每个结尾的维度上，轴的长度是匹配的，或者长度为1。然后广播会在缺失的，或长度为1的维度上进行。</p>

<p>考虑一下上面的例子，假设我们想要减去每一列的平均值。因为<code>arr.mean(0)</code>长度为3，而且arr的尾部维度也是3，二者匹配，所以是能沿着轴为0进行广播的。根据上面的规则，要想沿着轴为1减去平均值（即每一行减去当前行的平均值），最小的数组形状必须是（4，1）：</p>

<pre><code class="language-python">arr
</code></pre>

<pre><code>array([[ 0.19112706, -0.07585204,  1.33214545],
       [-1.51473946,  1.29163832,  0.22056989],
       [ 0.5696424 , -1.11391716,  0.13913336],
       [ 1.2059608 , -0.71633243, -0.2735593 ]])
</code></pre>

<pre><code class="language-python">row_means = arr.mean(1)
row_means
</code></pre>

<pre><code>array([ 0.48247349, -0.00084375, -0.13504713,  0.07202302])
</code></pre>

<pre><code class="language-python">row_means.shape
</code></pre>

<pre><code>(4,)
</code></pre>

<pre><code class="language-python">row_means.reshape((4, 1))
</code></pre>

<pre><code>array([[ 0.48247349],
       [-0.00084375],
       [-0.13504713],
       [ 0.07202302]])
</code></pre>

<pre><code class="language-python">demeaned = arr - row_means.reshape((4, 1))
demeaned
</code></pre>

<pre><code>array([[-0.29134643, -0.55832553,  0.84967196],
       [-1.51389571,  1.29248207,  0.22141364],
       [ 0.70468953, -0.97887003,  0.2741805 ],
       [ 1.13393778, -0.78835545, -0.34558232]])
</code></pre>

<pre><code class="language-python">demeaned.mean(1) # 下面的数字可以理解为0
</code></pre>

<pre><code>array([ -3.70074342e-17,  -2.77555756e-17,   1.85037171e-17,
         1.85037171e-17])
</code></pre>

<p>上面操作的示意图：</p>

<p><img src="http://pacdb2bfr.bkt.clouddn.com/blog/image/180803/A00iiDDG00.png?imageslim" alt="mark" /></p>

<p>下面是把一个二维数组加到一个三维数组上，沿着轴为0：</p>

<p><img src="http://pacdb2bfr.bkt.clouddn.com/blog/image/180803/09K65LgJA2.png?imageslim" alt="mark" /></p>

<h1 id="1-broadcasting-over-other-axes-在其他轴上进行广播">1 Broadcasting Over Other Axes（在其他轴上进行广播）</h1>

<p>在高维数组上进行广播要小心一些，不然就会得到下面这样的错误：</p>

<pre><code class="language-python">arr - arr.mean(1)
</code></pre>

<pre><code>---------------------------------------------------------------------------

ValueError                                Traceback (most recent call last)

&lt;ipython-input-17-7b87b85a20b2&gt; in &lt;module&gt;()
----&gt; 1 arr - arr.mean(1)


ValueError: operands could not be broadcast together with shapes (4,3) (4,)
</code></pre>

<p>根据广播的规则，在一个小数组上，广播的维度必须是1。下面的例子里，把维度从(4,)变为了(4, 1):</p>

<pre><code class="language-python">arr - arr.mean(1).reshape((4, 1))
</code></pre>

<pre><code>array([[-0.29134643, -0.55832553,  0.84967196],
       [-1.51389571,  1.29248207,  0.22141364],
       [ 0.70468953, -0.97887003,  0.2741805 ],
       [ 1.13393778, -0.78835545, -0.34558232]])
</code></pre>

<p>对于三维的数组，只需要把数据变形为合适的形状即可。下图展示了如何在一个三位数组上的每一个维度进行广播：</p>

<p><img src="http://pacdb2bfr.bkt.clouddn.com/blog/image/180803/i1DIJjfEb8.png?imageslim" alt="mark" /></p>

<p>所以有一个问题，就是要给长度为1的数组添加一个轴，才能用于广播。使用reshape是一种方法，但是插入一个轴需要构建一个元组用来指明新的形状，这个比较玛法。因此，numpy数组提供了一个特别的语法，通过索引来插入新的轴。这里使用np.newaxis属性：</p>

<pre><code class="language-python">arr = np.zeros((4, 4))
arr
</code></pre>

<pre><code>array([[ 0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.]])
</code></pre>

<pre><code class="language-python">arr_3d = arr[:, np.newaxis, :]
print(arr_3d.shape)
print(arr_3d)
</code></pre>

<pre><code>(4, 1, 4)
[[[ 0.  0.  0.  0.]]

 [[ 0.  0.  0.  0.]]

 [[ 0.  0.  0.  0.]]

 [[ 0.  0.  0.  0.]]]
</code></pre>

<pre><code class="language-python">arr_1d = np.random.normal(size=3)
arr_1d
</code></pre>

<pre><code>array([ 1.13938971,  0.36583158, -2.66511773])
</code></pre>

<pre><code class="language-python">arr_1d[:, np.newaxis]
</code></pre>

<pre><code>array([[ 1.13938971],
       [ 0.36583158],
       [-2.66511773]])
</code></pre>

<pre><code class="language-python">arr_1d[np.newaxis, :]
</code></pre>

<pre><code>array([[ 1.13938971,  0.36583158, -2.66511773]])
</code></pre>

<p>如果我们有一个三维数组，想要在轴2上减去平均值，我们需要这么做：</p>

<pre><code class="language-python">arr = np.random.randn(3, 4, 5)
depth_means = arr.mean(2)
depth_means
</code></pre>

<pre><code>array([[-0.76576042, -0.34515386, -0.29435899, -0.6558081 ],
       [ 0.33125031,  0.45033654, -0.67248223,  0.51666093],
       [-0.63660478, -0.4296203 ,  0.44219882,  0.32036302]])
</code></pre>

<pre><code class="language-python">depth_means.shape
</code></pre>

<pre><code>(3, 4)
</code></pre>

<pre><code class="language-python">demeaned = arr - depth_means[:, :, np.newaxis]
demeaned.mean(2) # 下面的结果可以理解为0
</code></pre>

<pre><code>array([[ -8.88178420e-17,   4.44089210e-17,   3.33066907e-17,
          4.44089210e-17],
       [ -1.66533454e-17,  -1.11022302e-17,   1.11022302e-16,
          6.66133815e-17],
       [ -6.66133815e-17,   0.00000000e+00,   0.00000000e+00,
          4.44089210e-17]])
</code></pre>

<p>我们可能会奇怪是否可以在不牺牲性能的同时，在一个轴上进行减去中平均值的操作。有，但是需要一些特别的索引方法：</p>

<pre><code class="language-python">def demean_axis(arr, axis=0):
    means = arr.mean(axis)

    # This generalizes things like [:, :, np.newaxis] to N dimensions
    indexer = [slice(None)] * arr.ndim
    indexer[axis] = np.newaxis
    return arr - means[indexer]
</code></pre>

<h1 id="2-setting-array-values-by-broadcasting-通过广播设置数组值">2 Setting Array Values by Broadcasting（通过广播设置数组值）</h1>

<p>上面讲到的广播规则，同样可以适用于通过索引设置值。比如：</p>

<pre><code class="language-python">arr = np.zeros((4, 3))
arr
</code></pre>

<pre><code>array([[ 0.,  0.,  0.],
       [ 0.,  0.,  0.],
       [ 0.,  0.,  0.],
       [ 0.,  0.,  0.]])
</code></pre>

<pre><code class="language-python">arr[:] = 5
arr
</code></pre>

<pre><code>array([[ 5.,  5.,  5.],
       [ 5.,  5.,  5.],
       [ 5.,  5.,  5.],
       [ 5.,  5.,  5.]])
</code></pre>

<p>然而，如果我们有一个想要设置为列的一维数组，只要形状符合就能做到：</p>

<pre><code class="language-python">col = np.array([1.28, -0.42, 0.44, 1.6])
</code></pre>

<pre><code class="language-python">arr[:] = col[:, np.newaxis]
arr
</code></pre>

<pre><code>array([[ 1.28,  1.28,  1.28],
       [-0.42, -0.42, -0.42],
       [ 0.44,  0.44,  0.44],
       [ 1.6 ,  1.6 ,  1.6 ]])
</code></pre>

<pre><code class="language-python">arr[:2] = [[-1.37], [0.509]]
arr
</code></pre>

<pre><code>array([[-1.37 , -1.37 , -1.37 ],
       [ 0.509,  0.509,  0.509],
       [ 0.44 ,  0.44 ,  0.44 ],
       [ 1.6  ,  1.6  ,  1.6  ]])
</code></pre>

    </div>

    
    

    
    

    <footer class="post-footer">
      

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/01-%E7%9F%A5%E8%AF%86%E6%A0%91/03-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/01-%E5%9F%BA%E7%A1%80%E7%BC%96%E7%A8%8B/01-%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/02-python/02data/02-numpy/11-%E9%AB%98%E7%BA%A7ufunc%E7%94%A8%E6%B3%95/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">11 高级ufunc用法</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/01-%E7%9F%A5%E8%AF%86%E6%A0%91/03-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/01-%E5%9F%BA%E7%A1%80%E7%BC%96%E7%A8%8B/01-%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/02-python/02data/02-numpy/09-%E6%95%B0%E7%BB%84%E6%93%8D%E4%BD%9C%E7%9A%84%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/">
            <span class="next-text nav-default">09 数组操作的高级用法</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="iteratelyd@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="http://github.com/iterateself" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/thebegin/activities" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://www.douban.com/people/68028070/" class="iconfont icon-douban" title="douban"></a>
  <a href="http://iterate.site/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
    <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">iterateself</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>


<script type="text/javascript" src="/dist/even.min.js?v=3.2.0"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>








</body>
</html>
