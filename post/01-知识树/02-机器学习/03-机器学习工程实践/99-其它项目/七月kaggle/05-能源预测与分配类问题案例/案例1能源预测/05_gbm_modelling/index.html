<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>05_GBM_modelling - 迭代自己</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="iterateself" />
  <meta name="description" content="Gradient Boosting Machine建模 载入每个区的 NYISO 数据，合并之后用 GBM 建模。 import pandas as pd import numpy as np import matplotlib.pyplot as plt import joblib %matplotlib inline weather_dict = joblib.load(&#39;weather_dict.pkl&#39;) weather_dict[&#39;N.Y.C.&#39;] (&#39;kjfk&#39;, &#39;NYC&#39;, &#39;NYC&#39;) region = &#39;N.Y.C.&#39; place = weather_dict[region][1].lower().replace(&#39; &#39;,&#39;&#39;) full = pd.read_csv(&#39;full_{0}_features.csv&#39;.format(place)) full.head() timestamp load weathertime temperaturef dewpointf humidity" />

  <meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.47.1" />


<link rel="canonical" href="http://iterate.site/post/01-%E7%9F%A5%E8%AF%86%E6%A0%91/02-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/03-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/99-%E5%85%B6%E5%AE%83%E9%A1%B9%E7%9B%AE/%E4%B8%83%E6%9C%88kaggle/05-%E8%83%BD%E6%BA%90%E9%A2%84%E6%B5%8B%E4%B8%8E%E5%88%86%E9%85%8D%E7%B1%BB%E9%97%AE%E9%A2%98%E6%A1%88%E4%BE%8B/%E6%A1%88%E4%BE%8B1%E8%83%BD%E6%BA%90%E9%A2%84%E6%B5%8B/05_gbm_modelling/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">




<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<link href="/dist/even.min.css?v=3.2.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="05_GBM_modelling" />
<meta property="og:description" content="Gradient Boosting Machine建模 载入每个区的 NYISO 数据，合并之后用 GBM 建模。 import pandas as pd import numpy as np import matplotlib.pyplot as plt import joblib %matplotlib inline weather_dict = joblib.load(&#39;weather_dict.pkl&#39;) weather_dict[&#39;N.Y.C.&#39;] (&#39;kjfk&#39;, &#39;NYC&#39;, &#39;NYC&#39;) region = &#39;N.Y.C.&#39; place = weather_dict[region][1].lower().replace(&#39; &#39;,&#39;&#39;) full = pd.read_csv(&#39;full_{0}_features.csv&#39;.format(place)) full.head() timestamp load weathertime temperaturef dewpointf humidity" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://iterate.site/post/01-%E7%9F%A5%E8%AF%86%E6%A0%91/02-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/03-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/99-%E5%85%B6%E5%AE%83%E9%A1%B9%E7%9B%AE/%E4%B8%83%E6%9C%88kaggle/05-%E8%83%BD%E6%BA%90%E9%A2%84%E6%B5%8B%E4%B8%8E%E5%88%86%E9%85%8D%E7%B1%BB%E9%97%AE%E9%A2%98%E6%A1%88%E4%BE%8B/%E6%A1%88%E4%BE%8B1%E8%83%BD%E6%BA%90%E9%A2%84%E6%B5%8B/05_gbm_modelling/" /><meta property="article:published_time" content="2018-07-25T08:00:27&#43;00:00"/>
<meta property="article:modified_time" content="2018-07-25T08:00:27&#43;00:00"/>
<meta itemprop="name" content="05_GBM_modelling">
<meta itemprop="description" content="Gradient Boosting Machine建模 载入每个区的 NYISO 数据，合并之后用 GBM 建模。 import pandas as pd import numpy as np import matplotlib.pyplot as plt import joblib %matplotlib inline weather_dict = joblib.load(&#39;weather_dict.pkl&#39;) weather_dict[&#39;N.Y.C.&#39;] (&#39;kjfk&#39;, &#39;NYC&#39;, &#39;NYC&#39;) region = &#39;N.Y.C.&#39; place = weather_dict[region][1].lower().replace(&#39; &#39;,&#39;&#39;) full = pd.read_csv(&#39;full_{0}_features.csv&#39;.format(place)) full.head() timestamp load weathertime temperaturef dewpointf humidity">


<meta itemprop="datePublished" content="2018-07-25T08:00:27&#43;00:00" />
<meta itemprop="dateModified" content="2018-07-25T08:00:27&#43;00:00" />
<meta itemprop="wordCount" content="799">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="05_GBM_modelling"/>
<meta name="twitter:description" content="Gradient Boosting Machine建模 载入每个区的 NYISO 数据，合并之后用 GBM 建模。 import pandas as pd import numpy as np import matplotlib.pyplot as plt import joblib %matplotlib inline weather_dict = joblib.load(&#39;weather_dict.pkl&#39;) weather_dict[&#39;N.Y.C.&#39;] (&#39;kjfk&#39;, &#39;NYC&#39;, &#39;NYC&#39;) region = &#39;N.Y.C.&#39; place = weather_dict[region][1].lower().replace(&#39; &#39;,&#39;&#39;) full = pd.read_csv(&#39;full_{0}_features.csv&#39;.format(place)) full.head() timestamp load weathertime temperaturef dewpointf humidity"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">迭代自己</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a><a href="/catalog/">
        <li class="mobile-menu-item">完整目录</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">迭代自己</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/catalog/">完整目录</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">05_GBM_modelling</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-07-25 </span>
        
        <span class="more-meta"> 799 words </span>
        <span class="more-meta"> 2 mins read </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#gradient-boosting-machine建模">Gradient Boosting Machine建模</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    

    
    <div class="post-content">
      

<h2 id="gradient-boosting-machine建模">Gradient Boosting Machine建模</h2>

<p>载入每个区的 NYISO 数据，合并之后用 GBM 建模。</p>

<pre><code class="language-python">import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import joblib
%matplotlib inline
</code></pre>

<pre><code class="language-python">weather_dict = joblib.load('weather_dict.pkl')
</code></pre>

<pre><code class="language-python">weather_dict['N.Y.C.']
</code></pre>

<pre><code>('kjfk', 'NYC', 'NYC')
</code></pre>

<pre><code class="language-python">region = 'N.Y.C.'
place = weather_dict[region][1].lower().replace(' ','')
full = pd.read_csv('full_{0}_features.csv'.format(place))
</code></pre>

<pre><code class="language-python">full.head()
</code></pre>

<table>
<thead>
<tr>
<th></th>
<th>timestamp</th>
<th>load</th>
<th>weathertime</th>
<th>temperaturef</th>
<th>dewpointf</th>
<th>humidity</th>
<th>sealevelpressurein</th>
<th>winddirection</th>
<th>windspeedmph</th>
<th>precipitationin</th>
<th>dow</th>
<th>doy</th>
<th>day</th>
<th>month</th>
<th>year</th>
<th>hour</th>
<th>minute</th>
<th>t_m24</th>
<th>t_m48</th>
<th>tdif</th>
</tr>
</thead>

<tbody>
<tr>
<td>0</td>
<td>2012-01-01 00:00:00</td>
<td>5061.5</td>
<td>2012-01-01 00:51:00</td>
<td>46</td>
<td>37</td>
<td>71</td>
<td>30.04</td>
<td>WNW</td>
<td>10.4</td>
<td>0</td>
<td>6</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>2012</td>
<td>0</td>
<td>0</td>
<td>5061.5</td>
<td>5061.5</td>
<td>0</td>
</tr>

<tr>
<td>1</td>
<td>2012-01-01 00:00:00</td>
<td>5061.5</td>
<td>2012-01-01 00:51:00</td>
<td>46</td>
<td>37</td>
<td>71</td>
<td>30.04</td>
<td>WNW</td>
<td>10.4</td>
<td>0</td>
<td>6</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>2012</td>
<td>0</td>
<td>0</td>
<td>5061.5</td>
<td>5061.5</td>
<td>0</td>
</tr>

<tr>
<td>2</td>
<td>2012-01-01 00:05:00</td>
<td>5030.0</td>
<td>2012-01-01 00:51:00</td>
<td>46</td>
<td>37</td>
<td>71</td>
<td>30.04</td>
<td>WNW</td>
<td>10.4</td>
<td>0</td>
<td>6</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>2012</td>
<td>0</td>
<td>5</td>
<td>5030.0</td>
<td>5030.0</td>
<td>0</td>
</tr>

<tr>
<td>3</td>
<td>2012-01-01 00:05:00</td>
<td>5030.0</td>
<td>2012-01-01 00:51:00</td>
<td>46</td>
<td>37</td>
<td>71</td>
<td>30.04</td>
<td>WNW</td>
<td>10.4</td>
<td>0</td>
<td>6</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>2012</td>
<td>0</td>
<td>5</td>
<td>5030.0</td>
<td>5030.0</td>
<td>0</td>
</tr>

<tr>
<td>4</td>
<td>2012-01-01 00:10:00</td>
<td>5011.5</td>
<td>2012-01-01 00:51:00</td>
<td>46</td>
<td>37</td>
<td>71</td>
<td>30.04</td>
<td>WNW</td>
<td>10.4</td>
<td>0</td>
<td>6</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>2012</td>
<td>0</td>
<td>10</td>
<td>5011.5</td>
<td>5011.5</td>
<td>0</td>
</tr>
</tbody>
</table>

<pre><code class="language-python">full.dropna(inplace=True)
</code></pre>

<pre><code class="language-python">%time full['timestamp'] = full['timestamp'].apply(lambda x: pd.to_datetime(x))
</code></pre>

<pre><code>CPU times: user 55.8 s, sys: 965 ms, total: 56.8 s
Wall time: 57.3 s
</code></pre>

<pre><code class="language-python">from sklearn.ensemble import GradientBoostingRegressor
from sklearn.cross_validation import train_test_split
</code></pre>

<p>Use this list to test the model performance with different combinations of features.</p>

<pre><code class="language-python">features = [\
          'temperaturef',\
#           'dewpointf', \
#           'humidity', \
#           'sealevelpressurein', \
#          'windspeedmph', \
#           'precipitationin',\
            'year',\
            'dow',\
            'doy', \
#           'month',\
#           'hour',\
            'minute',\
#           't_m24', \
#           't_m48', \
#           't_m1',\
         ]
</code></pre>

<p>其实  feature 这个地方做了一个选择，其实可以全量先丢进去，然后用 XGBoost 或者 GradientBoostMachine 去跑一遍，然后把 feature importance 特征的重要度拿出来，做一个排序。然后把里面真正有用的特征留下来，这是完全可以的。<span style="color:red;">具体怎么做？怎么拿出特征的重要度？前几节课里好像讲到过。下面提到了：<code>zip(features, list(gbr.feature_importances_))</code></span></p>

<pre><code class="language-python">X_train = full[full.timestamp &lt; pd.to_datetime('2015')][features]
X_test = full[full.timestamp &gt;= pd.to_datetime('2015')][features]

y_train = full[full.timestamp &lt; pd.to_datetime('2015')]['load']
y_test = full[full.timestamp &gt;= pd.to_datetime('2015')]['load']
</code></pre>

<pre><code class="language-python">gbr = GradientBoostingRegressor(loss='ls',
                                n_estimators=100,
                                max_depth=3,
                                verbose=1,
                                warm_start=True)
</code></pre>

<pre><code class="language-python">gbr_fitted = gbr.fit(X_train, y_train)
</code></pre>

<pre><code>      Iter       Train Loss   Remaining Time
         1     1433777.9602           40.40s
         2     1266661.9115           33.42s
         3     1128864.2468           33.91s
         4     1016488.9487           33.12s
         5      924162.8882           32.86s
         6      844857.8927           31.83s
         7      778376.1653           31.19s
         8      723249.4004           31.27s
         9      676961.8092           32.10s
        10      639059.8139           32.37s
        20      359979.0310           28.17s
        30      260246.8057           24.17s
        40      216447.4121           20.95s
        50      190852.9143           16.88s
        60      176315.3805           13.17s
        70      166255.7610            9.64s
        80      159546.2387            6.39s
        90      153307.5116            3.18s
       100      148946.2941            0.00s
</code></pre>

<pre><code class="language-python">gbr.score(X_test, y_test)
</code></pre>

<pre><code>0.77475116238962427
</code></pre>

<pre><code class="language-python">zip(features, list(gbr.feature_importances_))
</code></pre>

<p><span style="color:red;">嗯，原来这里就能看到 feature<em>importances</em> </span></p>

<pre><code>[('temperaturef', 0.17890179117890534),
 ('dow', 0.11158108116580837),
 ('doy', 0.41029644779391),
 ('minute', 0.29922067986137668)]
</code></pre>

<p>了解你的 GBM 模型状态如何，画出随着 estimator 个数增加 Error 变化状况。（有兴趣可以看看early stopping）。</p>

<pre><code class="language-python">def deviance_plot(est, X_test, y_test, ax = None, label = '', train_color='#2c7bb6', test_color = '#d7191c', alpha= 1.0, ylim = (0,1000000)):

    n_estimators = len(est.estimators_)
    test_dev = np.empty(n_estimators)

    for i, pred in enumerate(est.staged_predict(X_test)):
        test_dev[i] = est.loss_(y_test, pred)

    if ax is None:
        fig = plt.figure(figsize = (12,8))
        ax = plt.gca()

    ax.plot(np.arange(n_estimators) + 1, test_dev, color= test_color, label = 'Test %s' % label, linewidth=2, alpha=alpha)
    ax.plot(np.arange(n_estimators) + 1, est.train_score_, color = train_color, label= 'Train %s' % label, linewidth=2, alpha=alpha)
    ax.set_ylabel('Error')
    ax.set_xlabel('n_estimators')
    ax.set_ylim(ylim)
    return test_dev, ax

test_dev, ax = deviance_plot(gbr, X_test, y_test)
ax.legend(loc='upper right')

# add some annotations
# ax.annotate('Lowest test error', xy=(test_dev.argmin() + 1, test_dev.min() + 0.02),
#             xytext=(150, 3.5), **annotation_kw)

# ann = ax.annotate('', xy=(800, test_dev[799]),  xycoords='data',
#                   xytext=(800, est.train_score_[799]), textcoords='data',
#                   arrowprops={'arrowstyle': '&lt;-&gt;'})
# ax.text(810, 3.5, 'train-test gap')
</code></pre>

<pre><code>&lt;matplotlib.legend.Legend at 0x11120c510&gt;
</code></pre>

<p><img src="http://pacdb2bfr.bkt.clouddn.com/blog/image/180725/fmBgDfFb17.png?imageslim" alt="mark" /></p>

<p><span style="color:red;">看来画图也是一项技术活，并不是随随便便就能画出来的，也需要认真做。</span></p>

<p><span style="color:red;">从上图可以看出，大概 60 课树以上的时候就有 overfitting 了。</span></p>

<p>不过为什么他的 score 只有 0.7 之前在小数据集上的时候还有 0.9 的。是因为只使用了几个特征吗？</p>

    </div>

    
    

    
    

    <footer class="post-footer">
      

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/01-%E7%9F%A5%E8%AF%86%E6%A0%91/02-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/03-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/99-%E5%85%B6%E5%AE%83%E9%A1%B9%E7%9B%AE/%E4%B8%83%E6%9C%88kaggle/05-%E8%83%BD%E6%BA%90%E9%A2%84%E6%B5%8B%E4%B8%8E%E5%88%86%E9%85%8D%E7%B1%BB%E9%97%AE%E9%A2%98%E6%A1%88%E4%BE%8B/%E6%A1%88%E4%BE%8B1%E8%83%BD%E6%BA%90%E9%A2%84%E6%B5%8B/06_compare_results/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">06_compare_results</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/01-%E7%9F%A5%E8%AF%86%E6%A0%91/02-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/03-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5/99-%E5%85%B6%E5%AE%83%E9%A1%B9%E7%9B%AE/%E4%B8%83%E6%9C%88kaggle/05-%E8%83%BD%E6%BA%90%E9%A2%84%E6%B5%8B%E4%B8%8E%E5%88%86%E9%85%8D%E7%B1%BB%E9%97%AE%E9%A2%98%E6%A1%88%E4%BE%8B/%E6%A1%88%E4%BE%8B1%E8%83%BD%E6%BA%90%E9%A2%84%E6%B5%8B/04_clean_and_combine_data/">
            <span class="next-text nav-default">04_clean_and_combine_data</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="iteratelyd@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="http://github.com/iterateself" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/thebegin/activities" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://www.douban.com/people/68028070/" class="iconfont icon-douban" title="douban"></a>
  <a href="http://iterate.site/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
    <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">iterateself</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>


<script type="text/javascript" src="/dist/even.min.js?v=3.2.0"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>








</body>
</html>
